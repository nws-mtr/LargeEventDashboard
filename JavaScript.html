<script>
// ============================================================================
// JavaScript.html — Client-side Dashboard Logic
// Leaflet WMS radar + satellite maps, SVG forecasts, google.script.run RPC
// ============================================================================

// ── Weather Dashboard ─────────────────────────────────────────────────────
class WeatherDashboard {
  constructor() {
    this.config = null;
    this.radarMap = null;
    this.activeRadarLayer = null;
    this.radarCounties = null;

    this.satelliteMap = null;
    this.activeSatLayer = null;
    this.satLabelsLayer = null;
    this.satCounties = null;
    this.satelliteChannel = 'G18-ABI-CONUS-BAND02'; // default to VIS
    this.init();
  }

  init() {
    this.loadConfig();
    this.setupClock();
    this.initRadarMap();
    this.initSatelliteMap();
    this.loadAllData();
    this.startAutoRefresh();
  }

  // ── Config ────────────────────────────────────────────────────────────
  loadConfig() {
    google.script.run
      .withSuccessHandler(function(config) {
        this.config = config;
        this.updateEventInfo();
      }.bind(this))
      .withFailureHandler(function(err) {
        console.error('Config error:', err);
      })
      .getConfig();
  }

  updateEventInfo() {
    if (!this.config) return;
    // Event name is hardcoded in HTML as "Super Bowl LX Weather"
    document.getElementById('event-location').textContent = this.config.location;

    var startDate = new Date(this.config.startDate);
    document.getElementById('event-date').textContent = startDate.toLocaleDateString('en-US', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    document.getElementById('timezone').textContent = this.config.timezone;
  }

  // ── Clock ─────────────────────────────────────────────────────────────
  setupClock() {
    var updateClock = function() {
      var now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false,
        timeZone: 'America/Los_Angeles'
      });
    };
    updateClock();
    setInterval(updateClock, 1000);
  }

  // ── Load All Data ─────────────────────────────────────────────────────
  loadAllData() {
    this.loadCurrentWeather();
    this.loadHourlyForecast();
    this.loadKeyPoints();
    this.loadLatestRadarFrame();
    this.loadLatestSatelliteFrame();
    this.updateLastUpdateTime();
  }

  // ── Radar: Leaflet Map + WMS ──────────────────────────────────────────
  initRadarMap() {
    var venueLatLng = [37.403147, -121.969814];

    this.radarMap = L.map('radar-map', {
      center: venueLatLng,
      zoom: 9,
      zoomControl: true,
      attributionControl: true
    });

    // Dark basemap (CartoDB Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(this.radarMap);

    // Venue marker
    var venueIcon = L.divIcon({
      className: 'venue-marker',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });
    L.marker(venueLatLng, { icon: venueIcon, zIndex: 1000 })
      .addTo(this.radarMap)
      .bindPopup("<b>Levi's Stadium</b><br>Super Bowl LX");

    // 10 NM range ring (~18.52 km)
    L.circle(venueLatLng, {
      radius: 18520,
      color: 'rgba(255,255,255,0.4)',
      weight: 1,
      dashArray: '6,4',
      fill: false
    }).addTo(this.radarMap);

    // US County boundaries overlay (TIGER WMS)
    this.radarCounties = L.tileLayer.wms('https://tigerweb.geo.census.gov/arcgis/services/TIGERweb/tigerWMS_Current/MapServer/WMSServer', {
      layers: '84',  // Counties layer
      format: 'image/png',
      transparent: true,
      styles: '',
      attribution: 'US Census Bureau',
      pane: 'overlayPane',
      opacity: 1
    }).addTo(this.radarMap);

    // Add timestamp overlay div
    var radarTimestamp = L.DomUtil.create('div', 'map-timestamp-overlay');
    radarTimestamp.id = 'radar-timestamp-overlay';
    radarTimestamp.textContent = 'Loading...';
    document.getElementById('radar-map').appendChild(radarTimestamp);

    // Load latest radar frame
    this.loadLatestRadarFrame();
  }

  loadLatestRadarFrame() {
    // Fetch WMS time dimension via Code.gs
    google.script.run
      .withSuccessHandler(function(data) {
        if (data.error) {
          console.error('Radar times error:', data.error);
          document.getElementById('radar-timestamp-overlay').textContent = 'Error loading';
          return;
        }
        var times = data.times || [];
        if (times.length === 0) {
          document.getElementById('radar-timestamp-overlay').textContent = 'No data';
          return;
        }

        // Show only the latest frame
        var latestTime = times[times.length - 1];
        this.showRadarFrame(latestTime);
      }.bind(this))
      .withFailureHandler(function(err) {
        console.error('Radar times fetch error:', err);
        document.getElementById('radar-timestamp-overlay').textContent = 'Error loading';
      })
      .getRadarTimes();
  }

  showRadarFrame(timeStr) {
    // Remove existing radar layer if any
    if (this.activeRadarLayer) {
      this.radarMap.removeLayer(this.activeRadarLayer);
    }

    // Create WMS tile layer for this timestamp
    this.activeRadarLayer = L.tileLayer.wms(
      'https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows?', {
        layers: 'conus_bref_qcd',
        format: 'image/png',
        transparent: true,
        version: '1.3.0',
        crs: L.CRS.EPSG3857,
        styles: 'radar_reflectivity',
        time: timeStr,
        opacity: 0.7,
        attribution: 'MRMS — NOAA/NCEP'
      }
    );

    this.activeRadarLayer.addTo(this.radarMap);

    // Ensure county boundaries stay on top
    if (this.radarCounties) {
      this.radarCounties.bringToFront();
    }

    // Update timestamp overlay
    document.getElementById('radar-timestamp-overlay').textContent =
      this.formatTimePST(timeStr);
  }

  // ── Satellite: Leaflet Map + SSEC RealEarth Tile Loop (GOES-18) ─────
  initSatelliteMap() {
    var venueLatLng = [37.403147, -121.969814];

    this.satelliteMap = L.map('satellite-map', {
      center: venueLatLng,
      zoom: 7,
      zoomControl: true,
      attributionControl: true
    });

    // Dark basemap (CartoDB Dark Matter) — subtle under satellite imagery
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 12
    }).addTo(this.satelliteMap);

    // Venue marker
    var venueIcon = L.divIcon({
      className: 'venue-marker',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });
    L.marker(venueLatLng, { icon: venueIcon, zIndex: 1000 })
      .addTo(this.satelliteMap)
      .bindPopup("<b>Levi's Stadium</b><br>Super Bowl LX");

    // 50 NM range ring (~92.6 km) — wider view for satellite
    L.circle(venueLatLng, {
      radius: 92600,
      color: 'rgba(255,255,255,0.25)',
      weight: 1,
      dashArray: '6,4',
      fill: false
    }).addTo(this.satelliteMap);

    // Labels overlay on top of satellite
    this.satLabelsLayer = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        maxZoom: 12,
        pane: 'overlayPane'
      }
    ).addTo(this.satelliteMap);

    // US County boundaries overlay (TIGER WMS)
    this.satCounties = L.tileLayer.wms('https://tigerweb.geo.census.gov/arcgis/services/TIGERweb/tigerWMS_Current/MapServer/WMSServer', {
      layers: '84',  // Counties layer
      format: 'image/png',
      transparent: true,
      styles: '',
      attribution: 'US Census Bureau',
      pane: 'overlayPane',
      opacity: 1
    }).addTo(this.satelliteMap);

    // Add timestamp overlay div
    var satTimestamp = L.DomUtil.create('div', 'map-timestamp-overlay');
    satTimestamp.id = 'satellite-timestamp-overlay';
    satTimestamp.textContent = 'Loading...';
    document.getElementById('satellite-map').appendChild(satTimestamp);

    // Channel selector buttons
    var channelBtns = document.querySelectorAll('.channel-btn');
    var self = this;
    channelBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        channelBtns.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        self.satelliteChannel = btn.getAttribute('data-channel');
        // Load latest frame for new channel
        self.loadLatestSatelliteFrame();
      });
    });

    // Load latest satellite frame
    this.loadLatestSatelliteFrame();
  }

  loadLatestSatelliteFrame() {
    // Fetch SSEC RealEarth times for the selected channel
    google.script.run
      .withSuccessHandler(function(data) {
        if (data.error) {
          console.error('Satellite times error:', data.error);
          document.getElementById('satellite-timestamp-overlay').textContent = 'Error loading';
          return;
        }
        var times = data.times || [];
        if (times.length === 0) {
          document.getElementById('satellite-timestamp-overlay').textContent = 'No data';
          return;
        }

        // Show only the latest frame
        var latestTime = times[times.length - 1];
        this.showSatelliteFrame(latestTime, data.channelName);
      }.bind(this))
      .withFailureHandler(function(err) {
        console.error('Satellite times fetch error:', err);
        document.getElementById('satellite-timestamp-overlay').textContent = 'Error loading';
      })
      .getSatelliteTimes(this.satelliteChannel);
  }

  showSatelliteFrame(timeStr, channelName) {
    // Remove existing satellite layer if any
    if (this.activeSatLayer) {
      this.satelliteMap.removeLayer(this.activeSatLayer);
    }

    // Create tile layer for this SSEC timestamp
    this.activeSatLayer = L.tileLayer(
      'https://realearth.ssec.wisc.edu/api/image?products=' +
        this.satelliteChannel + '.100&x={x}&y={y}&z={z}&time=' + timeStr, {
        opacity: 0.85,
        maxZoom: 12,
        crossOrigin: 'anonymous',
        referrerPolicy: 'no-referrer',
        attribution: 'GOES-18 — SSEC RealEarth'
      }
    );

    this.activeSatLayer.addTo(this.satelliteMap);

    // Ensure labels stay on top
    if (this.satLabelsLayer) {
      this.satLabelsLayer.bringToFront();
    }

    // Ensure county boundaries stay on top
    if (this.satCounties) {
      this.satCounties.bringToFront();
    }

    // Update timestamp overlay
    var channelNames = {
      'G18-ABI-CONUS-BAND02': 'Visible',
      'G18-ABI-CONUS-BAND09': 'Water Vapor',
      'G18-ABI-CONUS-BAND13': 'Clean IR'
    };
    var chName = channelName || channelNames[this.satelliteChannel] || this.satelliteChannel;
    document.getElementById('satellite-timestamp-overlay').textContent =
      this.formatSsecTime(timeStr);
  }

  // Format SSEC time string "20260208.020117" → "6:01 PM" in PST
  formatSsecTime(ssecStr) {
    try {
      var iso = ssecStr.substring(0,4) + '-' + ssecStr.substring(4,6) + '-' +
                ssecStr.substring(6,8) + 'T' + ssecStr.substring(9,11) + ':' +
                ssecStr.substring(11,13) + ':' + ssecStr.substring(13,15) + 'Z';
      return new Date(iso).toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true,
        timeZone: 'America/Los_Angeles'
      });
    } catch (e) {
      return ssecStr;
    }
  }

  // ── Current Weather ───────────────────────────────────────────────────
  loadCurrentWeather() {
    google.script.run
      .withSuccessHandler(function(data) {
        if (data.error) { console.error('Weather error:', data.error); return; }

        var obs = data.observations;

        // Temperature
        var temp = obs.temperature ? obs.temperature.value : null;
        document.getElementById('current-temp').textContent = temp !== null ? Math.round(temp) : '--';

        // Observation time
        if (data.observationTime) {
          var obsDate = new Date(data.observationTime);
          document.getElementById('obs-time').textContent = 'Obs: ' + obsDate.toLocaleTimeString('en-US', {
            hour: 'numeric', minute: '2-digit', hour12: true, timeZone: 'America/Los_Angeles'
          });
        }

        // Station info
        if (data.station) {
          var stLabel = data.station.id || '';
          if (data.station.name) stLabel += ' — ' + data.station.name;
          if (data.station.distance) stLabel += ' (' + data.station.distance.toFixed(1) + ' mi)';
          document.getElementById('obs-station').textContent = stLabel;
        }

        // Feels Like (wind chill)
        var windSpeed = (obs.wind && obs.wind.speed) ? obs.wind.speed.value : 0;
        var feelsLike = temp;
        if (temp !== null && windSpeed > 3 && temp < 50) {
          feelsLike = 35.74 + (0.6215 * temp) - (35.75 * Math.pow(windSpeed, 0.16))
                    + (0.4275 * temp * Math.pow(windSpeed, 0.16));
        }
        document.getElementById('feels-like').textContent =
          feelsLike !== null ? Math.round(feelsLike) + '°F' : '--';

        // Dewpoint
        var dp = obs.dewpoint ? obs.dewpoint.value : null;
        document.getElementById('dewpoint').textContent = dp !== null ? Math.round(dp) + '°F' : '--';

        // Humidity
        var rh = obs.relativeHumidity ? obs.relativeHumidity.value : null;
        document.getElementById('humidity').textContent = rh !== null ? Math.round(rh) + '%' : '--';

        // Wind (cardinal + speed)
        var cardinal = obs.wind ? obs.wind.cardinal : '';
        var ws = obs.wind && obs.wind.speed ? obs.wind.speed.value : null;
        document.getElementById('wind').textContent =
          ws !== null ? cardinal + ' ' + Math.round(ws) + ' mph' : '--';

        // Wind direction (cardinal)
        document.getElementById('wind-dir').textContent = cardinal || '--';

        // Gusts
        var gust = obs.wind && obs.wind.gust ? obs.wind.gust.value : null;
        document.getElementById('wind-gust').textContent =
          (gust !== null && gust > 0) ? Math.round(gust) + ' mph' : 'None';

        // 1-hr Precipitation
        var precip = obs.precipitation && obs.precipitation.oneHour ? obs.precipitation.oneHour.value : null;
        document.getElementById('precip-1hr').textContent =
          (precip !== null && precip > 0) ? precip.toFixed(2) + '"' : '0.00"';

        // Data source in footer
        if (data.source && data.station) {
          document.querySelector('.data-sources').textContent =
            'Data: ' + data.source + ' (' + data.station.id + ') / NOAA NWS / SSEC RealEarth GOES-18';
        }
      })
      .withFailureHandler(function(err) {
        console.error('Weather fetch error:', err);
      })
      .getCurrentWeather();
  }

  // ── Hourly Forecast (Gridpoint Time Series) ────────────────────────────
  loadHourlyForecast() {
    google.script.run
      .withSuccessHandler(function(data) {
        if (data.error) {
          console.error('Gridpoint forecast error:', data.error);
          document.getElementById('hourly-container').innerHTML =
            '<div class="error-msg">' + data.error + '</div>';
          return;
        }

        var hours = data.hours || [];
        if (hours.length === 0) {
          document.getElementById('hourly-container').innerHTML =
            '<div class="error-msg">No gridpoint data available</div>';
          return;
        }

        // ── Build graphical time series ──
        this.buildTimelineChart(hours, data.adverseThresholds);

      }.bind(this))
      .withFailureHandler(function(err) {
        console.error('Gridpoint forecast fetch error:', err);
        document.getElementById('hourly-container').innerHTML =
          '<div class="error-msg">Failed to load gridpoint forecast</div>';
      })
      .getGridpointForecast();
  }

  // ── Build Graphical Timeline Chart ──────────────────────────────────────
  buildTimelineChart(hours, thresholds) {
    var container = document.getElementById('hourly-container');
    
    // Get thresholds (with defaults if not provided)
    var maxTempThresh = (thresholds && thresholds.maxTemp) || 80;
    var minRainThresh = (thresholds && thresholds.minRainChance) || 15;
    var minSkyThresh  = (thresholds && thresholds.minSkyCover) || 50;
    
    // Extract data arrays
    var temps = hours.map(function(h) { return h.temperature; });
    var rains = hours.map(function(h) { return h.probabilityOfPrecipitation; });
    var skies = hours.map(function(h) { return h.skyCover; });
    
    // Format time labels (show every 3rd hour to avoid crowding)
    var labels = hours.map(function(h, i) {
      var dt = new Date(h.time);
      var hr = dt.toLocaleTimeString('en-US', {
        hour: 'numeric', hour12: true, timeZone: 'America/Los_Angeles'
      });
      if (i % 3 === 0) {
        var day = dt.toLocaleDateString('en-US', {
          weekday: 'short', timeZone: 'America/Los_Angeles'
        });
        return hr + '|' + day;
      }
      return null; // skip label for non-3rd hours
    });
    
    // Build HTML
    var html = '<div class="timeline-chart">';
    
    html += '<div class="timeline-rows">';
    
    // Temperature row
    html += '<div class="timeline-row">' +
      '<div class="row-header">Temperature (°F)</div>' +
      '<div class="row-graph" id="graph-temp"></div></div>';
    
    // Rain chance row
    html += '<div class="timeline-row">' +
      '<div class="row-header">Rain Chance (%)</div>' +
      '<div class="row-graph" id="graph-rain"></div></div>';
    
    // Cloud cover row
    html += '<div class="timeline-row">' +
      '<div class="row-header">Cloud Cover (%)</div>' +
      '<div class="row-graph" id="graph-sky"></div></div>';
    
    html += '</div></div>';
    
    container.innerHTML = html;
    
    // Now render SVG into each graph container
    var self = this;
    // Use requestAnimationFrame so the DOM has time to layout
    requestAnimationFrame(function() {
      self.renderLineGraph('graph-temp', temps, labels, '#2196f3', 'temp', maxTempThresh, 'above', hours);
      self.renderLineGraph('graph-rain', rains, labels, '#4caf50', 'pct', minRainThresh, 'above', hours);
      self.renderLineGraph('graph-sky', skies, labels, '#9e9e9e', 'pct', minSkyThresh, 'above', hours);
    });
  }

  // ── Render SVG Line Graph ──────────────────────────────────────────────
  renderLineGraph(containerId, data, labels, color, mode, threshold, threshDir, hours) {
    var container = document.getElementById(containerId);
    if (!container) return;
    
    var w = container.clientWidth;
    var h = container.clientHeight;
    if (w === 0 || h === 0) return;
    
    // Margins (increased left/bottom for larger font)
    var ml = 38, mr = 8, mt = 14, mb = 28;
    var pw = w - ml - mr;
    var ph = h - mt - mb;
    
    // Compute Y range
    var validData = data.filter(function(v) { return v !== null; });
    if (validData.length === 0) {
      container.innerHTML = '<div style="text-align:center;color:#9fa8da;padding:1rem;font-size:0.8rem;">No data</div>';
      return;
    }
    
    var yMin, yMax;
    if (mode === 'pct') {
      yMin = 0;
      yMax = 100;
    } else {
      // Anchor to 5-degree increments for temperature
      yMin = Math.floor((Math.min.apply(null, validData) - 2) / 5) * 5;
      yMax = Math.ceil((Math.max.apply(null, validData) + 2) / 5) * 5;
      if (yMax - yMin < 10) {
        var mid = (yMax + yMin) / 2;
        yMin = Math.floor((mid - 5) / 5) * 5;
        yMax = Math.ceil((mid + 5) / 5) * 5;
      }
    }
    var yRange = yMax - yMin || 1;
    
    // Helper: data index → x,y position
    var n = data.length;
    function getX(i) { return ml + (i / (n - 1)) * pw; }
    function getY(val) { return mt + ph - ((val - yMin) / yRange) * ph; }
    
    // Build SVG
    var svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="none" style="width:100%;height:100%">';
    
    // Adverse region shading
    if (threshold !== null && threshold !== undefined) {
      var inAdverse = false;
      var segStart = 0;
      for (var i = 0; i < n; i++) {
        var val = data[i];
        var isAdverse = val !== null && val > threshold;
        if (isAdverse && !inAdverse) {
          segStart = i;
          inAdverse = true;
        }
        if ((!isAdverse || i === n - 1) && inAdverse) {
          var segEnd = isAdverse ? i : i - 1;
          var x1 = getX(Math.max(0, segStart - 0.5));
          var x2 = getX(Math.min(n - 1, segEnd + 0.5));
          svg += '<rect x="' + x1 + '" y="' + mt + '" width="' + (x2 - x1) + '" height="' + ph + '" fill="rgba(255,193,7,0.12)" stroke="rgba(255,193,7,0.35)" stroke-width="1" stroke-dasharray="4,2"/>';
          inAdverse = false;
        }
      }
    }
    
    // Threshold line
    if (threshold !== null && threshold !== undefined && threshold >= yMin && threshold <= yMax) {
      var threshY = getY(threshold);
      svg += '<line x1="' + ml + '" y1="' + threshY + '" x2="' + (w - mr) + '" y2="' + threshY + '" stroke="rgba(255,193,7,0.5)" stroke-width="1" stroke-dasharray="6,3"/>';
      svg += '<text x="' + (w - mr - 2) + '" y="' + (threshY - 3) + '" text-anchor="end" fill="rgba(255,193,7,0.7)" font-size="11" font-weight="600">' + threshold + '</text>';
    }
    
    // Horizontal grid lines
    if (mode === 'pct') {
      // Percentage mode: 4 evenly spaced lines (0, 25, 50, 75, 100), skip lowest
      for (var g = 1; g <= 4; g++) {
        var gVal = yMin + (g / 4) * yRange;
        var gy = getY(gVal);
        svg += '<line x1="' + ml + '" y1="' + gy + '" x2="' + (w - mr) + '" y2="' + gy + '" stroke="rgba(40,53,147,0.3)" stroke-width="0.5"/>';
        svg += '<text x="' + (ml - 4) + '" y="' + (gy + 4) + '" text-anchor="end" fill="#9fa8da" font-size="13">' + Math.round(gVal) + '</text>';
      }
    } else {
      // Temperature mode: gridlines at every 5-degree increment, skip lowest
      var firstLabel = true;
      for (var gVal = yMin; gVal <= yMax; gVal += 5) {
        var gy = getY(gVal);
        svg += '<line x1="' + ml + '" y1="' + gy + '" x2="' + (w - mr) + '" y2="' + gy + '" stroke="rgba(40,53,147,0.3)" stroke-width="0.5"/>';
        if (!firstLabel) {
          svg += '<text x="' + (ml - 4) + '" y="' + (gy + 4) + '" text-anchor="end" fill="#9fa8da" font-size="13">' + Math.round(gVal) + '</text>';
        }
        firstLabel = false;
      }
    }
    
    // Vertical grid lines at every hourly data point (light grey, slightly opaque)
    for (var i = 0; i < n; i++) {
      var vx = getX(i);
      svg += '<line x1="' + vx + '" y1="' + mt + '" x2="' + vx + '" y2="' + (h - mb) + '" stroke="rgba(200,200,200,0.12)" stroke-width="0.5"/>';
    }
    
    // Vertical grid lines + time labels (at label positions only)
    for (var i = 0; i < labels.length; i++) {
      if (labels[i] !== null) {
        var lx = getX(i);
        svg += '<line x1="' + lx + '" y1="' + mt + '" x2="' + lx + '" y2="' + (h - mb) + '" stroke="rgba(40,53,147,0.2)" stroke-width="0.5"/>';
        var parts = labels[i].split('|');
        svg += '<text x="' + lx + '" y="' + (h - mb + 13) + '" text-anchor="middle" fill="#9fa8da" font-size="13">' + parts[0] + '</text>';
        if (parts[1]) {
          svg += '<text x="' + lx + '" y="' + (h - mb + 24) + '" text-anchor="middle" fill="#7986cb" font-size="11">' + parts[1] + '</text>';
        }
      }
    }
    
    // ── Kickoff vertical line at 3:30 PM local time ──
    if (hours && hours.length > 0) {
      var kickoffDate = new Date('2026-02-08T15:30:00-08:00'); // 3:30 PM PST
      var firstTime = new Date(hours[0].time).getTime();
      var lastTime = new Date(hours[hours.length - 1].time).getTime();
      var kickoffMs = kickoffDate.getTime();
      if (kickoffMs >= firstTime && kickoffMs <= lastTime) {
        // Interpolate fractional index
        var kickoffIdx = (kickoffMs - firstTime) / (lastTime - firstTime) * (n - 1);
        var kx = ml + (kickoffIdx / (n - 1)) * pw;
        svg += '<line x1="' + kx.toFixed(1) + '" y1="' + mt + '" x2="' + kx.toFixed(1) + '" y2="' + (h - mb) + '" stroke="#f44336" stroke-width="3"/>';
        svg += '<text x="' + (kx + 4).toFixed(1) + '" y="' + (mt + 12) + '" fill="#f44336" font-size="14" font-weight="700">Kickoff</text>';
      }
    }
    
    // Data line path
    var pathParts = [];
    var dotsSvg = '';
    var firstPoint = true;
    for (var i = 0; i < n; i++) {
      if (data[i] === null) continue;
      var px = getX(i);
      var py = getY(data[i]);
      pathParts.push((firstPoint ? 'M' : 'L') + px.toFixed(1) + ',' + py.toFixed(1));
      firstPoint = false;
      
      // Data point dot
      var isAdverse = data[i] > threshold;
      var dotColor = isAdverse ? '#ffc107' : color;
      var dotR = isAdverse ? 3 : 2;
      dotsSvg += '<circle cx="' + px.toFixed(1) + '" cy="' + py.toFixed(1) + '" r="' + dotR + '" fill="' + dotColor + '"/>';
    }
    
    // Area fill under line
    if (pathParts.length > 1) {
      var areaPath = pathParts.join(' ');
      var lastValidIdx = -1;
      var firstValidIdx = -1;
      for (var i = n - 1; i >= 0; i--) {
        if (data[i] !== null) { lastValidIdx = i; break; }
      }
      for (var i = 0; i < n; i++) {
        if (data[i] !== null) { firstValidIdx = i; break; }
      }
      if (firstValidIdx >= 0 && lastValidIdx >= 0) {
        areaPath += ' L' + getX(lastValidIdx).toFixed(1) + ',' + (mt + ph);
        areaPath += ' L' + getX(firstValidIdx).toFixed(1) + ',' + (mt + ph) + ' Z';
        svg += '<path d="' + areaPath + '" fill="' + color + '" fill-opacity="0.1"/>';
      }
      
      // Line
      svg += '<path d="' + pathParts.join(' ') + '" fill="none" stroke="' + color + '" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>';
    }
    
    // Dots on top
    svg += dotsSvg;
    
    svg += '</svg>';
    container.innerHTML = svg;
  }

  // ── Key Points (AI-generated forecast bullets) ─────────────────────────
  loadKeyPoints() {
    google.script.run
      .withSuccessHandler(function(data) {
        var container = document.getElementById('keypoints-container');

        if (data.error) {
          console.error('Key points error:', data.error);
          container.innerHTML = '<div class="error-msg">Unable to generate key points</div>';
          return;
        }

        var bullets = data.bullets || [];
        if (bullets.length === 0) {
          container.innerHTML = '<div class="error-msg">No key points available</div>';
          return;
        }

        var html = '<ul class="keypoints-list">';
        for (var i = 0; i < bullets.length; i++) {
          html += '<li class="keypoint-item">' + bullets[i] + '</li>';
        }
        html += '</ul>';
        container.innerHTML = html;
      })
      .withFailureHandler(function(err) {
        console.error('Key points fetch error:', err);
        document.getElementById('keypoints-container').innerHTML =
          '<div class="error-msg">Failed to load key points</div>';
      })
      .getKeyPoints();
  }

  // ── Utility ───────────────────────────────────────────────────────────
  formatTimePST(isoStr) {
    try {
      var dt = new Date(isoStr);
      return dt.toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true,
        timeZone: 'America/Los_Angeles'
      });
    } catch (e) {
      return isoStr;
    }
  }

  updateLastUpdateTime() {
    document.getElementById('last-update').textContent =
      new Date().toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles' });
  }

  // ── Auto Refresh ──────────────────────────────────────────────────────
  startAutoRefresh() {
    var self = this;

    // Full page refresh every 1 hour (more reliable than setInterval for long-running dashboards)
    setTimeout(function() {
      window.location.reload();
    }, 60 * 60 * 1000);

    // Radar WMS times every 2 min
    setInterval(function() {
      self.loadRadarTimes();
    }, 2 * 60 * 1000);

    // Satellite times every 5 min
    setInterval(function() {
      self.loadSatelliteTimes();
    }, 5 * 60 * 1000);
  }
}

// ── Init on DOM ready ─────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', function() {
  new WeatherDashboard();
});
</script>
