<script>
// ============================================================================
// JavaScript.html — Client-side Dashboard Logic
// Leaflet WMS radar loop + satellite image loop + google.script.run RPC
// ============================================================================

// ── Loop Player (reusable for radar WMS and satellite images) ─────────────
class LoopPlayer {
  constructor(opts) {
    this.id = opts.id;               // 'radar' or 'satellite'
    this.frames = [];                // array of frame data (timestamps or URLs)
    this.currentIndex = 0;
    this.playing = false;
    this.intervalId = null;
    this.speed = opts.speed || 500;  // ms per frame
    this.onFrame = opts.onFrame;     // callback(frameData, index)

    // DOM elements
    this.playBtn = document.getElementById(this.id + '-play');
    this.stepBack = document.getElementById(this.id + '-step-back');
    this.stepFwd = document.getElementById(this.id + '-step-fwd');
    this.scrubber = document.getElementById(this.id + '-scrubber');
    this.counter = document.getElementById(this.id + '-frame-counter');
    this.timestamp = document.getElementById(this.id + '-timestamp');

    this.bindEvents();
  }

  bindEvents() {
    var self = this;
    this.playBtn.addEventListener('click', function() { self.togglePlay(); });
    this.stepBack.addEventListener('click', function() { self.pause(); self.step(-1); });
    this.stepFwd.addEventListener('click', function() { self.pause(); self.step(1); });
    this.scrubber.addEventListener('input', function() {
      self.pause();
      self.goTo(parseInt(self.scrubber.value));
    });
  }

  setFrames(frames) {
    this.frames = frames || [];
    this.currentIndex = Math.max(0, this.frames.length - 1); // start at latest
    this.scrubber.min = 0;
    this.scrubber.max = Math.max(0, this.frames.length - 1);
    this.scrubber.value = this.currentIndex;
    this.updateUI();
    if (this.frames.length > 0) {
      this.showFrame();
    }
  }

  showFrame() {
    if (this.frames.length === 0) return;
    var frame = this.frames[this.currentIndex];
    if (this.onFrame) this.onFrame(frame, this.currentIndex);
    this.updateUI();
  }

  updateUI() {
    var total = this.frames.length;
    this.counter.textContent = total > 0 ? (this.currentIndex + 1) + ' / ' + total : '0 / 0';
    this.scrubber.value = this.currentIndex;
    this.playBtn.textContent = this.playing ? '⏸' : '▶';
    if (this.playing) {
      this.playBtn.classList.add('playing');
    } else {
      this.playBtn.classList.remove('playing');
    }
  }

  step(direction) {
    if (this.frames.length === 0) return;
    this.currentIndex = (this.currentIndex + direction + this.frames.length) % this.frames.length;
    this.showFrame();
  }

  goTo(index) {
    if (index < 0 || index >= this.frames.length) return;
    this.currentIndex = index;
    this.showFrame();
  }

  play() {
    if (this.frames.length < 2) return;
    this.playing = true;
    this.updateUI();
    var self = this;
    this.intervalId = setInterval(function() {
      self.step(1);
    }, this.speed);
  }

  pause() {
    this.playing = false;
    if (this.intervalId) {
      clearInterval(this.intervalId);
      this.intervalId = null;
    }
    this.updateUI();
  }

  togglePlay() {
    if (this.playing) { this.pause(); } else { this.play(); }
  }
}


// ── Weather Dashboard ─────────────────────────────────────────────────────
class WeatherDashboard {
  constructor() {
    this.config = null;
    this.radarMap = null;
    this.radarWmsLayers = {};    // keyed by ISO timestamp
    this.radarTimes = [];
    this.activeRadarTime = null;
    this.radarPlayer = null;

    this.satelliteMap = null;
    this.satelliteWmsLayers = {};   // keyed by SSEC timestamp
    this.satelliteTimes = [];
    this.activeSatTime = null;
    this.satellitePlayer = null;
    this.satelliteChannel = 'G18-ABI-CONUS-BAND02'; // default to visible
    this.init();
  }

  init() {
    this.loadConfig();
    this.setupClock();
    this.initRadarMap();
    this.initSatelliteMap();
    this.loadAllData();
    this.startAutoRefresh();
  }

  // ── Config ────────────────────────────────────────────────────────────
  loadConfig() {
    google.script.run
      .withSuccessHandler(function(config) {
        this.config = config;
        this.updateEventInfo();
      }.bind(this))
      .withFailureHandler(function(err) {
        console.error('Config error:', err);
      })
      .getConfig();
  }

  updateEventInfo() {
    if (!this.config) return;
    document.getElementById('event-name').textContent = this.config.name;
    document.getElementById('event-location').textContent = this.config.location;

    var startDate = new Date(this.config.startDate);
    document.getElementById('event-date').textContent = startDate.toLocaleDateString('en-US', {
      weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
    });

    document.getElementById('timezone').textContent = this.config.timezone;
  }

  // ── Clock ─────────────────────────────────────────────────────────────
  setupClock() {
    var updateClock = function() {
      var now = new Date();
      document.getElementById('clock').textContent = now.toLocaleTimeString('en-US', {
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false,
        timeZone: 'America/Los_Angeles'
      });
    };
    updateClock();
    setInterval(updateClock, 1000);
  }

  // ── Load All Data ─────────────────────────────────────────────────────
  loadAllData() {
    this.loadCurrentWeather();
    this.loadHourlyForecast();
    this.loadWeatherAlerts();
    this.loadRadarTimes();
    this.loadSatelliteTimes();
    this.updateLastUpdateTime();
  }

  // ── Radar: Leaflet Map + WMS ──────────────────────────────────────────
  initRadarMap() {
    var venueLatLng = [37.403147, -121.969814];

    this.radarMap = L.map('radar-map', {
      center: venueLatLng,
      zoom: 9,
      zoomControl: true,
      attributionControl: true
    });

    // Dark basemap (CartoDB Dark Matter)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(this.radarMap);

    // Venue marker
    var venueIcon = L.divIcon({
      className: 'venue-marker',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });
    L.marker(venueLatLng, { icon: venueIcon, zIndex: 1000 })
      .addTo(this.radarMap)
      .bindPopup("<b>Levi's Stadium</b><br>Super Bowl LX");

    // 10 NM range ring (~18.52 km)
    L.circle(venueLatLng, {
      radius: 18520,
      color: 'rgba(255,255,255,0.4)',
      weight: 1,
      dashArray: '6,4',
      fill: false
    }).addTo(this.radarMap);

    // Init loop player
    var self = this;
    this.radarPlayer = new LoopPlayer({
      id: 'radar',
      speed: 400,
      onFrame: function(timeStr, index) {
        self.showRadarFrame(timeStr);
      }
    });

    // Refresh button fetches new WMS times
    document.getElementById('radar-refresh').addEventListener('click', function() {
      self.loadRadarTimes();
    });
  }

  loadRadarTimes() {
    // Fetch WMS time dimension via Code.gs (pre-filtered to last 30 min)
    google.script.run
      .withSuccessHandler(function(data) {
        if (data.error) {
          console.error('Radar times error:', data.error);
          return;
        }
        this.radarTimes = data.times || [];
        // Server already filters to last 30 min — use all returned frames
        this.radarPlayer.setFrames(this.radarTimes);

        // Update timestamp display
        if (this.radarTimes.length > 0) {
          var latest = this.radarTimes[this.radarTimes.length - 1];
          document.getElementById('radar-timestamp').textContent =
            this.formatTimePST(latest) + ' (MRMS)';
        }
        // Default: paused on latest frame (user can press play)
      }.bind(this))
      .withFailureHandler(function(err) {
        console.error('Radar times fetch error:', err);
      })
      .getRadarTimes();
  }

  showRadarFrame(timeStr) {
    // Hide current active WMS layer
    if (this.activeRadarTime && this.radarWmsLayers[this.activeRadarTime]) {
      this.radarMap.removeLayer(this.radarWmsLayers[this.activeRadarTime]);
    }

    // Create or reuse WMS tile layer for this timestamp
    if (!this.radarWmsLayers[timeStr]) {
      this.radarWmsLayers[timeStr] = L.tileLayer.wms(
        'https://opengeo.ncep.noaa.gov/geoserver/conus/conus_bref_qcd/ows?', {
          layers: 'conus_bref_qcd',
          format: 'image/png',
          transparent: true,
          version: '1.3.0',
          crs: L.CRS.EPSG3857,
          styles: 'radar_reflectivity',
          time: timeStr,
          opacity: 0.7,
          attribution: 'MRMS — NOAA/NCEP'
        }
      );
    }

    this.radarWmsLayers[timeStr].addTo(this.radarMap);
    this.activeRadarTime = timeStr;

    // Update timestamp label
    document.getElementById('radar-timestamp').textContent =
      this.formatTimePST(timeStr) + ' (MRMS)';

    // Garbage-collect old layers not in current loop set
    this.pruneRadarLayers();
  }

  pruneRadarLayers() {
    var currentFrames = this.radarPlayer.frames;
    var keep = {};
    for (var i = 0; i < currentFrames.length; i++) {
      keep[currentFrames[i]] = true;
    }
    for (var key in this.radarWmsLayers) {
      if (!keep[key] && key !== this.activeRadarTime) {
        this.radarMap.removeLayer(this.radarWmsLayers[key]);
        delete this.radarWmsLayers[key];
      }
    }
  }

  // ── Satellite: Leaflet Map + SSEC RealEarth Tile Loop (GOES-18) ─────
  initSatelliteMap() {
    var venueLatLng = [37.403147, -121.969814];

    this.satelliteMap = L.map('satellite-map', {
      center: venueLatLng,
      zoom: 7,
      zoomControl: true,
      attributionControl: true
    });

    // Dark basemap (CartoDB Dark Matter) — subtle under satellite imagery
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 12
    }).addTo(this.satelliteMap);

    // Venue marker
    var venueIcon = L.divIcon({
      className: 'venue-marker',
      iconSize: [12, 12],
      iconAnchor: [6, 6]
    });
    L.marker(venueLatLng, { icon: venueIcon, zIndex: 1000 })
      .addTo(this.satelliteMap)
      .bindPopup("<b>Levi's Stadium</b><br>Super Bowl LX");

    // 50 NM range ring (~92.6 km) — wider view for satellite
    L.circle(venueLatLng, {
      radius: 92600,
      color: 'rgba(255,255,255,0.25)',
      weight: 1,
      dashArray: '6,4',
      fill: false
    }).addTo(this.satelliteMap);

    // Labels overlay on top of satellite
    this.satLabelsLayer = L.tileLayer(
      'https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png', {
        subdomains: 'abcd',
        maxZoom: 12,
        pane: 'overlayPane'
      }
    ).addTo(this.satelliteMap);

    // Init satellite loop player
    var self = this;
    this.satellitePlayer = new LoopPlayer({
      id: 'satellite',
      speed: 500,
      onFrame: function(timeStr, index) {
        self.showSatelliteFrame(timeStr);
      }
    });

    // Refresh button
    document.getElementById('satellite-refresh').addEventListener('click', function() {
      self.loadSatelliteTimes();
    });

    // Channel selector buttons
    var channelBtns = document.querySelectorAll('.channel-btn');
    channelBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        channelBtns.forEach(function(b) { b.classList.remove('active'); });
        btn.classList.add('active');
        self.satelliteChannel = btn.getAttribute('data-channel');
        // Clear cached layers for old channel
        self.clearSatelliteLayers();
        self.loadSatelliteTimes();
      });
    });
  }

  loadSatelliteTimes() {
    // Fetch SSEC RealEarth times for the selected channel (pre-filtered to last 30 min)
    google.script.run
      .withSuccessHandler(function(data) {
        if (data.error) {
          console.error('Satellite times error:', data.error);
          document.getElementById('satellite-timestamp').textContent = 'Error loading';
          return;
        }
        this.satelliteTimes = data.times || [];
        this.satellitePlayer.setFrames(this.satelliteTimes);

        // Update timestamp display
        if (this.satelliteTimes.length > 0) {
          var latest = this.satelliteTimes[this.satelliteTimes.length - 1];
          document.getElementById('satellite-timestamp').textContent =
            this.formatSsecTime(latest) + ' (' + (data.channelName || this.satelliteChannel) + ')';
        }
        // Default: paused on latest frame
      }.bind(this))
      .withFailureHandler(function(err) {
        console.error('Satellite times fetch error:', err);
      })
      .getSatelliteTimes(this.satelliteChannel);
  }

  showSatelliteFrame(timeStr) {
    // Hide current active satellite layer
    if (this.activeSatTime && this.satelliteWmsLayers[this.activeSatTime]) {
      this.satelliteMap.removeLayer(this.satelliteWmsLayers[this.activeSatTime]);
    }

    // Create or reuse tile layer for this SSEC timestamp
    if (!this.satelliteWmsLayers[timeStr]) {
      // SSEC RealEarth tile URL: /api/image?products=CHANNEL.100&x={x}&y={y}&z={z}&time=TIMESTAMP
      this.satelliteWmsLayers[timeStr] = L.tileLayer(
        'https://realearth.ssec.wisc.edu/api/image?products=' +
          this.satelliteChannel + '.100&x={x}&y={y}&z={z}&time=' + timeStr, {
          opacity: 0.85,
          maxZoom: 12,
          crossOrigin: 'anonymous',
          referrerPolicy: 'no-referrer',
          attribution: 'GOES-18 — SSEC RealEarth'
        }
      );
    }

    this.satelliteWmsLayers[timeStr].addTo(this.satelliteMap);
    this.activeSatTime = timeStr;

    // Ensure labels stay on top
    if (this.satLabelsLayer) {
      this.satLabelsLayer.bringToFront();
    }

    // Update timestamp label
    var channelNames = {
      'G18-ABI-CONUS-BAND02': 'Visible',
      'G18-ABI-CONUS-BAND09': 'Water Vapor',
      'G18-ABI-CONUS-BAND13': 'Clean IR'
    };
    var chName = channelNames[this.satelliteChannel] || this.satelliteChannel;
    document.getElementById('satellite-timestamp').textContent =
      this.formatSsecTime(timeStr) + ' (' + chName + ')';

    // Garbage-collect old layers not in current loop set
    this.pruneSatelliteLayers();
  }

  clearSatelliteLayers() {
    for (var key in this.satelliteWmsLayers) {
      this.satelliteMap.removeLayer(this.satelliteWmsLayers[key]);
    }
    this.satelliteWmsLayers = {};
    this.activeSatTime = null;
  }

  pruneSatelliteLayers() {
    var currentFrames = this.satellitePlayer.frames;
    var keep = {};
    for (var i = 0; i < currentFrames.length; i++) {
      keep[currentFrames[i]] = true;
    }
    for (var key in this.satelliteWmsLayers) {
      if (!keep[key] && key !== this.activeSatTime) {
        this.satelliteMap.removeLayer(this.satelliteWmsLayers[key]);
        delete this.satelliteWmsLayers[key];
      }
    }
  }

  // Format SSEC time string "20260208.020117" → "6:01 PM" in PST
  formatSsecTime(ssecStr) {
    try {
      var iso = ssecStr.substring(0,4) + '-' + ssecStr.substring(4,6) + '-' +
                ssecStr.substring(6,8) + 'T' + ssecStr.substring(9,11) + ':' +
                ssecStr.substring(11,13) + ':' + ssecStr.substring(13,15) + 'Z';
      return new Date(iso).toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true,
        timeZone: 'America/Los_Angeles'
      });
    } catch (e) {
      return ssecStr;
    }
  }

  // ── Current Weather ───────────────────────────────────────────────────
  loadCurrentWeather() {
    google.script.run
      .withSuccessHandler(function(data) {
        if (data.error) { console.error('Weather error:', data.error); return; }

        var obs = data.observations;

        var temp = obs.temperature ? obs.temperature.value : null;
        document.getElementById('current-temp').textContent = temp !== null ? Math.round(temp) : '--';

        var windSpeed = (obs.wind && obs.wind.speed) ? obs.wind.speed.value : 0;
        var feelsLike = temp;
        if (temp !== null && windSpeed > 3 && temp < 50) {
          feelsLike = 35.74 + (0.6215 * temp) - (35.75 * Math.pow(windSpeed, 0.16))
                    + (0.4275 * temp * Math.pow(windSpeed, 0.16));
        }
        document.getElementById('feels-like').textContent =
          feelsLike !== null ? Math.round(feelsLike) + '°F' : '--';

        var dp = obs.dewpoint ? obs.dewpoint.value : null;
        document.getElementById('dewpoint').textContent = dp !== null ? Math.round(dp) + '°F' : '--';

        var rh = obs.relativeHumidity ? obs.relativeHumidity.value : null;
        document.getElementById('humidity').textContent = rh !== null ? Math.round(rh) + '%' : '--';

        var cardinal = obs.wind ? obs.wind.cardinal : '';
        var ws = obs.wind && obs.wind.speed ? obs.wind.speed.value : null;
        var gust = obs.wind && obs.wind.gust ? obs.wind.gust.value : null;
        var windText = '--';
        if (ws !== null) {
          windText = cardinal + ' ' + Math.round(ws) + ' mph';
          if (gust !== null && gust > ws) {
            windText += ' (gusts ' + Math.round(gust) + ')';
          }
        }
        document.getElementById('wind').textContent = windText;

        var pres = obs.pressure && obs.pressure.altimeter ? obs.pressure.altimeter.value : null;
        document.getElementById('pressure').textContent =
          pres !== null ? pres.toFixed(2) + ' inHg' : '--';

        var vis = obs.visibility ? obs.visibility.value : null;
        document.getElementById('visibility').textContent =
          vis !== null ? vis.toFixed(1) + ' mi' : '--';

        if (data.source && data.station) {
          document.querySelector('.data-sources').textContent =
            'Data: ' + data.source + ' (Station ' + data.station.id + ': ' + data.station.name + ')';
        }
      })
      .withFailureHandler(function(err) {
        console.error('Weather fetch error:', err);
      })
      .getCurrentWeather();
  }

  // ── Hourly Forecast (Gridpoint Time Series) ────────────────────────────
  loadHourlyForecast() {
    google.script.run
      .withSuccessHandler(function(data) {
        if (data.error) {
          console.error('Gridpoint forecast error:', data.error);
          document.getElementById('hourly-container').innerHTML =
            '<div class="error-msg">' + data.error + '</div>';
          return;
        }

        var hours = data.hours || [];
        if (hours.length === 0) {
          document.getElementById('hourly-container').innerHTML =
            '<div class="error-msg">No gridpoint data available</div>';
          return;
        }

        // ── Build scrollable table ──
        var container = document.getElementById('hourly-container');
        var tableHTML = '<div class="forecast-table-wrap"><table class="forecast-table">';

        // Header row
        tableHTML += '<thead><tr>' +
          '<th class="ft-sticky-col">Hour</th>' +
          '<th>Temp</th>' +
          '<th>Dewpt</th>' +
          '<th>RH</th>' +
          '<th>Wind</th>' +
          '<th>Gust</th>' +
          '<th>Sky</th>' +
          '<th>PoP</th>' +
          '<th>QPF</th>' +
          '</tr></thead><tbody>';

        for (var i = 0; i < hours.length; i++) {
          var h = hours[i];
          var dt = new Date(h.time);
          var timeStr = dt.toLocaleTimeString('en-US', {
            hour: 'numeric', hour12: true, timeZone: 'America/Los_Angeles'
          });
          var dayStr = dt.toLocaleDateString('en-US', {
            weekday: 'short', timeZone: 'America/Los_Angeles'
          });

          // Color-code temp
          var tempClass = '';
          if (h.temperature !== null) {
            if (h.temperature >= 80) tempClass = 'ft-hot';
            else if (h.temperature >= 60) tempClass = 'ft-warm';
            else if (h.temperature <= 32) tempClass = 'ft-freeze';
            else if (h.temperature <= 45) tempClass = 'ft-cold';
          }

          // Color-code PoP
          var popClass = '';
          if (h.probabilityOfPrecipitation !== null && h.probabilityOfPrecipitation > 0) {
            if (h.probabilityOfPrecipitation >= 60) popClass = 'ft-pop-high';
            else if (h.probabilityOfPrecipitation >= 30) popClass = 'ft-pop-med';
            else popClass = 'ft-pop-low';
          }

          // Wind string
          var windStr = '--';
          if (h.windSpeed !== null) {
            windStr = (h.windCardinal || '') + ' ' + Math.round(h.windSpeed);
          }

          var gustStr = h.windGust !== null ? Math.round(h.windGust) : '--';
          var skyStr = h.skyCover !== null ? h.skyCover + '%' : '--';
          var popStr = h.probabilityOfPrecipitation !== null ? h.probabilityOfPrecipitation + '%' : '--';
          var qpfStr = (h.qpf !== null && h.qpf > 0) ? h.qpf.toFixed(2) + '"' : '--';

          tableHTML += '<tr>' +
            '<td class="ft-sticky-col"><span class="ft-day">' + dayStr + '</span> ' + timeStr + '</td>' +
            '<td class="ft-temp ' + tempClass + '">' + (h.temperature !== null ? Math.round(h.temperature) + '°' : '--') + '</td>' +
            '<td class="ft-dewpt">' + (h.dewpoint !== null ? Math.round(h.dewpoint) + '°' : '--') + '</td>' +
            '<td>' + (h.relativeHumidity !== null ? h.relativeHumidity + '%' : '--') + '</td>' +
            '<td class="ft-wind">' + windStr + '</td>' +
            '<td class="ft-gust">' + gustStr + '</td>' +
            '<td>' + skyStr + '</td>' +
            '<td class="' + popClass + '">' + popStr + '</td>' +
            '<td>' + qpfStr + '</td>' +
            '</tr>';
        }

        tableHTML += '</tbody></table></div>';
        container.innerHTML = tableHTML;

        // ── Update Forecast Summary panel ──
        this.updateForecastSummary(hours);

      }.bind(this))
      .withFailureHandler(function(err) {
        console.error('Gridpoint forecast fetch error:', err);
        document.getElementById('hourly-container').innerHTML =
          '<div class="error-msg">Failed to load gridpoint forecast</div>';
      })
      .getGridpointForecast();
  }

  // ── Forecast Summary (derived from gridpoint data) ────────────────────
  updateForecastSummary(hours) {
    var summary = document.getElementById('forecast-summary');
    if (!hours || hours.length === 0) {
      summary.innerHTML = '<div class="error-msg">No data</div>';
      return;
    }

    // Compute summary stats from gridpoint hours
    var temps = hours.map(function(h) { return h.temperature; }).filter(function(v) { return v !== null; });
    var pops = hours.map(function(h) { return h.probabilityOfPrecipitation; }).filter(function(v) { return v !== null; });
    var winds = hours.map(function(h) { return h.windSpeed; }).filter(function(v) { return v !== null; });
    var gusts = hours.map(function(h) { return h.windGust; }).filter(function(v) { return v !== null; });
    var skies = hours.map(function(h) { return h.skyCover; }).filter(function(v) { return v !== null; });
    var qpfs = hours.map(function(h) { return h.qpf; }).filter(function(v) { return v !== null && v > 0; });

    var maxTemp = temps.length ? Math.round(Math.max.apply(null, temps)) : '--';
    var minTemp = temps.length ? Math.round(Math.min.apply(null, temps)) : '--';
    var maxPop = pops.length ? Math.max.apply(null, pops) : 0;
    var maxWind = winds.length ? Math.round(Math.max.apply(null, winds)) : '--';
    var maxGust = gusts.length ? Math.round(Math.max.apply(null, gusts)) : '--';
    var avgSky = skies.length ? Math.round(skies.reduce(function(a, b) { return a + b; }, 0) / skies.length) : '--';
    var totalQPF = qpfs.length ? qpfs.reduce(function(a, b) { return a + b; }, 0).toFixed(2) : '0.00';

    // Sky description
    var skyDesc = '--';
    if (typeof avgSky === 'number') {
      if (avgSky <= 10) skyDesc = 'Clear';
      else if (avgSky <= 30) skyDesc = 'Mostly Clear';
      else if (avgSky <= 60) skyDesc = 'Partly Cloudy';
      else if (avgSky <= 85) skyDesc = 'Mostly Cloudy';
      else skyDesc = 'Overcast';
    }

    // Precip risk
    var precipRisk = 'None';
    var precipClass = 'ft-pop-none';
    if (maxPop >= 60) { precipRisk = 'Likely (' + maxPop + '%)'; precipClass = 'ft-pop-high'; }
    else if (maxPop >= 30) { precipRisk = 'Chance (' + maxPop + '%)'; precipClass = 'ft-pop-med'; }
    else if (maxPop > 0) { precipRisk = 'Slight (' + maxPop + '%)'; precipClass = 'ft-pop-low'; }

    summary.innerHTML =
      '<div class="summary-grid">' +
        '<div class="summary-stat">' +
          '<div class="summary-label">Temp Range</div>' +
          '<div class="summary-value">' + minTemp + '° – ' + maxTemp + '°F</div>' +
        '</div>' +
        '<div class="summary-stat">' +
          '<div class="summary-label">Sky Cover</div>' +
          '<div class="summary-value">' + skyDesc + ' (' + avgSky + '%)</div>' +
        '</div>' +
        '<div class="summary-stat">' +
          '<div class="summary-label">Precip Risk</div>' +
          '<div class="summary-value ' + precipClass + '">' + precipRisk + '</div>' +
        '</div>' +
        '<div class="summary-stat">' +
          '<div class="summary-label">Total QPF</div>' +
          '<div class="summary-value">' + totalQPF + '"</div>' +
        '</div>' +
        '<div class="summary-stat">' +
          '<div class="summary-label">Max Wind</div>' +
          '<div class="summary-value">' + maxWind + ' mph</div>' +
        '</div>' +
        '<div class="summary-stat">' +
          '<div class="summary-label">Max Gust</div>' +
          '<div class="summary-value">' + maxGust + ' mph</div>' +
        '</div>' +
      '</div>' +
      '<div class="summary-source">Source: ' + 'NWS Gridpoint Raw Data (MTR)</div>';
  }

  // ── Weather Alerts ────────────────────────────────────────────────────
  loadWeatherAlerts() {
    google.script.run
      .withSuccessHandler(function(data) {
        var container = document.getElementById('alerts-container');

        if (data.alerts && data.alerts.length > 0) {
          container.innerHTML = data.alerts.map(function(alert) {
            var props = alert.properties;
            var severity = (props.severity || '').toLowerCase();
            var isSevere = severity === 'extreme' || severity === 'severe';

            return '<div class="alert-item ' + (isSevere ? 'severe' : '') + '">' +
              '<div class="alert-title">' + props.event + '</div>' +
              '<div class="alert-description">' + props.headline + '</div>' +
              '<div style="font-size:0.8rem;margin-top:0.5rem;color:var(--text-secondary)">' +
              new Date(props.effective).toLocaleString() + '</div></div>';
          }).join('');
        } else {
          container.innerHTML = '<p class="no-alerts">✅ No active alerts</p>';
        }
      })
      .withFailureHandler(function(err) {
        console.error('Alerts fetch error:', err);
      })
      .getWeatherAlerts();
  }

  // ── Utility ───────────────────────────────────────────────────────────
  formatTimePST(isoStr) {
    try {
      var dt = new Date(isoStr);
      return dt.toLocaleTimeString('en-US', {
        hour: 'numeric', minute: '2-digit', hour12: true,
        timeZone: 'America/Los_Angeles'
      });
    } catch (e) {
      return isoStr;
    }
  }

  updateLastUpdateTime() {
    document.getElementById('last-update').textContent =
      new Date().toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles' });
  }

  // ── Auto Refresh ──────────────────────────────────────────────────────
  startAutoRefresh() {
    var self = this;

    // Weather + forecast + alerts every 5 min
    setInterval(function() {
      self.loadCurrentWeather();
      self.loadHourlyForecast();
      self.loadWeatherAlerts();
      self.updateLastUpdateTime();
    }, 5 * 60 * 1000);

    // Radar WMS times every 2 min
    setInterval(function() {
      self.loadRadarTimes();
    }, 2 * 60 * 1000);

    // Satellite times every 5 min
    setInterval(function() {
      self.loadSatelliteTimes();
    }, 5 * 60 * 1000);
  }
}

// ── Init on DOM ready ─────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', function() {
  new WeatherDashboard();
});
</script>
